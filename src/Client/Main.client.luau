local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local StartupDiagnostics = require(ReplicatedStorage.Shared.Utilities.StartupDiagnostics)
local StartupLog = StartupDiagnostics.new("ClientMain")
local NETWORK_WAIT_TIMEOUT_SECONDS = 30

local function runStartupStep(stepName: string, callback: () -> ())
	StartupLog:Boundary(stepName, callback)
end

local NetworkFolder = StartupLog:ResolveDependency("ReplicatedStorage.Network", function()
	local existing = ReplicatedStorage:FindFirstChild("Network")
	if existing and existing:IsA("Folder") then
		return existing
	end

	local resolved = ReplicatedStorage:WaitForChild("Network", NETWORK_WAIT_TIMEOUT_SECONDS)
	assert(
		resolved and resolved:IsA("Folder"),
		("[ClientMain] Missing required folder ReplicatedStorage.Network after %ds"):format(NETWORK_WAIT_TIMEOUT_SECONDS)
	)

	return resolved
end) :: Folder

-- Require every packet definition before any remotes fire to avoid nil Packet registrations.
local function preloadPacketModules(folder: Instance)
	for _, child in ipairs(folder:GetChildren()) do
		if child:IsA("ModuleScript") then
			require(child)
		elseif child:IsA("Folder") then
			preloadPacketModules(child)
		end
	end
end

runStartupStep("PreloadNetworkPackets", function()
	preloadPacketModules(NetworkFolder)
end)

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
-- Cutaway system removed

local ModulesFolder = script.Parent.Modules

local SoundtrackManager = require(ModulesFolder.SoundtrackManager)
local DayAndNight = require(ModulesFolder.DayAndNight)
local PlotSelector = require(ModulesFolder.PlotSelector)
local PlotGrid = require(ModulesFolder.PlotGridOverlay)
local PlotExpansion = require(ModulesFolder.PlotExpansion)
local RoomDebugOverlay = require(ModulesFolder.RoomDebugOverlay)
local PlotStateStore = require(script.Parent.ClientStores.PlotStateStore)
local ButtonSoundController = require(ModulesFolder.ButtonSoundController)
local PlotBuilder = require(ModulesFolder.PlotBuilder)
local ObjectPreview = require(ModulesFolder.ObjectPreview)
local ObjectSelector = require(ModulesFolder.ObjectSelector)
local ObjectAction = require(ModulesFolder.ObjectAction)
local WorldEventController = require(ModulesFolder.WorldEventController)
local MailboxInteractionController = require(ModulesFolder.MailboxInteractionController)
local SurfacePaintController = require(ModulesFolder.SurfacePaintController)
local PreviewToolController = require(ModulesFolder.PreviewToolController)
local TenantProspectController = require(ModulesFolder.TenantProspectController)
local TenantInteractionController = require(ModulesFolder.TenantInteractionController)
local TenantHelpController = require(ModulesFolder.TenantHelpController)
local ChoreController = require(ModulesFolder.ChoreController)
local TipsController = require(ModulesFolder.TipsController)
local ReviewController = require(ModulesFolder.ReviewController)
local ReputationController = require(ModulesFolder.ReputationController)
local UtilityVisuals = require(ModulesFolder.UtilityVisuals)
local SelectionController = require(ModulesFolder.SelectionController)
local WireController = require(ModulesFolder.WireController)
local EnvironmentHUDController = require(ModulesFolder.EnvironmentHUDController)
local ThermostatInteractionController = require(ModulesFolder.ThermostatInteractionController)
local PowerSwitchController = require(ModulesFolder.PowerSwitchController)
local WeatherController = require(ModulesFolder.WeatherController)
local ResidentController = require(ModulesFolder.ResidentController)
local ProgressionController = require(ModulesFolder.ProgressionController)

local PlotBuilderUI = require(script.Parent.UserInterface.PlotBuilderUI)
local BuildPaletteUI = require(script.Parent.UserInterface.BuildPaletteUI)
local BillboardRadialUI = require(script.Parent.UserInterface.BillboardRadialUI)
-- local ResidentNeedsUI = require(script.Parent.UserInterface.ResidentNeedsUI)
local ResidentChatBubbles = require(script.Parent.UserInterface.ResidentChatBubbles)
local ResidentNameBillboard = require(script.Parent.UserInterface.ResidentNameBillboard)
local MainHUD = require(script.Parent.UserInterface.MainHUD)
local BillUI = require(script.Parent.UserInterface.BillUI)
local LevelUpUI = require(script.Parent.UserInterface.LevelUpUI)
local CraftingUI = require(script.Parent.UserInterface.CraftingUI)
local TradeUI = require(script.Parent.UserInterface.TradeUI)
local AchievementUI = require(script.Parent.UserInterface.AchievementUI)
local SeasonalEventUI = require(script.Parent.UserInterface.SeasonalEventUI)
local DailyRewardUI = require(script.Parent.UserInterface.DailyRewardUI)
--local TimeUI = require(script.Parent.UserInterface.TimeUI)

runStartupStep("ProgressionController.Init", function()
	ProgressionController.Init()
end)
runStartupStep("SoundtrackManager.Init", function()
	SoundtrackManager.Init()
end)
runStartupStep("DayAndNight.Init", function()
	DayAndNight.Init()
end)
runStartupStep("PlotGrid.Init", function()
	PlotGrid.Init()
end)
runStartupStep("PlotExpansion.Init", function()
	PlotExpansion.Init()
end)
runStartupStep("PlotStateStore.Init", function()
	PlotStateStore.Init()
end)
runStartupStep("RoomDebugOverlay.Init", function()
	RoomDebugOverlay.Init()
end)
--TimeUI.Init()
runStartupStep("ButtonSoundController.Init", function()
	ButtonSoundController.Init()
end)
runStartupStep("MainHUD.Init", function()
	MainHUD.Init()
end)
runStartupStep("BillUI.Init", function()
	BillUI.Init()
end)
runStartupStep("LevelUpUI.Init", function()
	LevelUpUI.Init()
end)
runStartupStep("CraftingUI.Init", function()
	CraftingUI.Init()
end)
runStartupStep("TradeUI.Init", function()
	TradeUI.Init()
end)
runStartupStep("AchievementUI.Init", function()
	AchievementUI.Init()
end)
runStartupStep("SeasonalEventUI.Init", function()
	SeasonalEventUI.Init()
end)
runStartupStep("DailyRewardUI.Init", function()
	DailyRewardUI.Init()
end)
runStartupStep("ObjectPreview.Init", function()
	ObjectPreview.Init()
end)
runStartupStep("PlotBuilder.Init", function()
	PlotBuilder.Init()
end)
runStartupStep("ObjectSelector.Init", function()
	ObjectSelector.Init()
end)
-- ResidentNeedsUI.Init()
runStartupStep("ObjectAction.Init", function()
	ObjectAction.Init()
end)
runStartupStep("WorldEventController.Init", function()
	WorldEventController.Init()
end)
runStartupStep("PlotBuilderUI.Init", function()
	PlotBuilderUI:Init()
end)
runStartupStep("BuildPaletteUI.Init", function()
	BuildPaletteUI.Init()
end)
runStartupStep("SurfacePaintController.Init", function()
	SurfacePaintController.Init()
end)
runStartupStep("PreviewToolController.Init", function()
	PreviewToolController.Init()
end)
runStartupStep("TenantProspectController.Init", function()
	TenantProspectController.Init()
end)
runStartupStep("TenantInteractionController.Init", function()
	TenantInteractionController.Init()
end)
runStartupStep("TenantHelpController.Init", function()
	TenantHelpController.Init()
end)
runStartupStep("ChoreController.Init", function()
	ChoreController.Init()
end)
runStartupStep("TipsController.Start", function()
	TipsController.Start()
end)
runStartupStep("ReviewController.Init", function()
	ReviewController.Init()
end)
runStartupStep("ReputationController.Init", function()
	ReputationController.Init()
end)
runStartupStep("BillboardRadialUI.Init", function()
	BillboardRadialUI.Init()
end)
runStartupStep("ResidentChatBubbles.Init", function()
	ResidentChatBubbles.Init()
end)
runStartupStep("ResidentNameBillboard.Init", function()
	ResidentNameBillboard.Init()
end)
runStartupStep("PlotSelector.Init", function()
	PlotSelector.Init()
end)
runStartupStep("MailboxInteractionController.Init", function()
	MailboxInteractionController.Init()
end)
runStartupStep("UtilityVisuals.Init", function()
	UtilityVisuals.Init()
end)
runStartupStep("SelectionController.Init", function()
	SelectionController.Init()
end)
runStartupStep("WireController.Init", function()
	WireController.Init()
end)
runStartupStep("EnvironmentHUDController.Init", function()
	EnvironmentHUDController.Init()
end)
runStartupStep("ThermostatInteractionController.Init", function()
	ThermostatInteractionController.Init()
end)
runStartupStep("PowerSwitchController.Init", function()
	PowerSwitchController.Init()
end)
runStartupStep("WeatherController.Start", function()
	WeatherController.Start()
end)
runStartupStep("ResidentController.Init", function()
	ResidentController.Init()
end)
local ResidentsStore = require(script.Parent.ClientStores.ResidentsStore) :: any
local TenantStore = require(script.Parent.ClientStores.TenantStore)

runStartupStep("ResidentsStore.Init", function()
	ResidentsStore.Init()
end)
runStartupStep("TenantStore.Init", function()
	TenantStore.Init()
end)
--RoomDebugOverlay.SetEnabled(true)
local function SetCollisionGroup(character: Model)
	for _, descendant in ipairs(character:GetDescendants()) do
		if descendant:IsA("BasePart") then
			descendant.CollisionGroup = "Players"
		end
	end
end

SetCollisionGroup(Character)

LocalPlayer.CharacterAdded:Connect(SetCollisionGroup)

for _, player in ipairs(Players:GetPlayers()) do
	if player ~= LocalPlayer then
		if player.Character then
			SetCollisionGroup(player.Character)
		end
		player.CharacterAdded:Connect(SetCollisionGroup)
	end
end

Players.PlayerAdded:Connect(function(player: Player)
	player.CharacterAdded:Connect(SetCollisionGroup)
end)
